define(["jquery","core/str","core/log","core/config","mod_sharedresource/metadata"],function(a,b,c,d,e){var f,g,h={bind_tabs:function(){c.debug("AMD Mod sharedresource metadata edition binding tab events"),a(".mtd-tab").bind("click",this.switch_tab),a(".mtd-tab a").bind("click",function(a){a.preventDefault()})},bind_all:function(){c.debug("AMD Mod sharedresource metadata edition binding all events"),a(".mtd-form-input").off("change"),a(".taxonomy-source").off("change"),a(".mtd-form-addbutton").off("click"),a(".mtd-form-element select").off("change"),a(".mtd-form-element textarea").off("keyup"),a('.mtd-form-element input[type="text"]').off("keyup"),a(".mtd-tab").off("click"),a(".mtd-tab a").off("click"),a('.mtd-form-element input[type="text"]').bind("keyup",this.check_empty),a(".mtd-form-element select").bind("change",this.check_empty),a(".mtd-form-element textarea").bind("keyup",this.check_empty),a(".mtd-form-addbutton").bind("click",this.add_node);var b="."+f+"-system-read";b+=",."+f+"-indexer-read",b+=",."+f+"-author-read",a(b).off("change"),a(b).bind("change",this.enable_search_widget_checkbox),a(".taxonomy-source").bind("change",this.reload_taxonomy),a("#id-mtd-form").on("change",".taxonomy-source",null,this.reload_taxonomy)},trigger_all:function(){c.debug("AMD Mod sharedresource metadata edition triggering changes"),a('.mtd-form-element input[type="text"]').trigger("keyup"),a(".mtd-form-element textarea").trigger("keyup")},init:function(d){f=d;var e=[{key:"fillprevious",component:"sharedresource"},{key:"fillcategory",component:"sharedresource"}];b.get_strings(e).done(function(a){g=a}),c.debug("AMD Mod sharedresource BIND ALL CALL"),h.bind_all(),h.bind_tabs(),h.trigger_all(),a(".mtd-form-addbutton").each(h.check_button_status),c.debug("AMD Mod sharedresource metadata edition form initialized"),a(".mtd-tab").removeClass("here"),a(".mtd-tab").removeClass("current"),a("#id-menu-1").addClass("here"),a("#id-menu-1").addClass("current"),a(".mtd-content").removeClass("active"),a(".mtd-content").removeClass("on"),a(".mtd-content").addClass("off"),a("#id-tab-1").addClass("active"),a("#id-tab-1").removeClass("off"),a("#id-tab-1").addClass("on"),c.debug("AMD Mod sharedresource metadata default switch to tab General")},check_button_status:function(){var b=a(this);c.debug("Check add button "+b.attr("id"));var d,e=b.attr("id").replace("id-add-",""),f=b.attr("data"),g=f.split(";"),i=!1,j="";for(d=g.shift();void 0!==d;){if(j=a("#"+d),c.debug("   Check button dep "+j.attr("id")),j.parent(".mtd-form-element").hasClass("is-empty")){i=!0;break}d=g.shift()}i?b.prop("disabled",!0):b.prop("disabled",!1),h.activate_up_chain(e)},switch_tab:function(b){b.stopPropagation();var c=a(this);c.attr("id")||(c=c.parent());var d=c.attr("id"),e=/id-menu-([^-]+)$/,f=c.attr("id").match(e),g="id-tab-"+f[1];a(".mtd-tab").removeClass("here"),a(".mtd-tab").removeClass("current"),a("#"+d).addClass("here"),a("#"+d).addClass("current"),a(".mtd-content").removeClass("active"),a(".mtd-content").removeClass("on"),a(".mtd-content").addClass("off"),a("#"+g).addClass("active"),a("#"+g).removeClass("off"),a("#"+g).addClass("on")},add_node:function(b){b.stopPropagation();var d=a(this),f=/btn-([^-]+)-([^-]+)/,i=d.attr("name").match(f),j=i[1],k=i[2],l="",m=d.attr("data-occur");if(c.debug("found real occur as "+m),"category"!=k){switch(k){case"text":case"codetext":if(""===a("#"+j).val())return void window.alert(g[0]);break;case"select":if("basicvalue"===a("#"+j).val())return void window.alert(g[0]);break;case"date":if("- Year -"===a("#"+j+"_dateyear").val())return void window.alert(g[0]);break;case"duration":if(!(""!==a("#"+j+"_Day").val()&&"0"!==a("#"+j+"_Day").val()||""!==a("#"+j+"_Hou").val()&&"0"!==a("#"+j+"_Hou").val()||""!==a("#"+j+"_Min").val()&&"0"!==a("#"+j+"_Min").val()||""!==a("#"+j+"_Sec").val()&&"0"!==a("#"+j+"_Sec").val()))return void window.alert(g[0]);break;case"vcard":if(l=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+j).val().replace(l,"").replace(/ /g,""))return void window.alert(g[0])}h.add_list_item(j,m)}else{for(var n,o=d.attr("data"),p=o.split(" "),q=0,r=0;r<p.length;r++)n=p[r],""===a("#"+n).val()&&q++,"basicvalue"===a("#"+n).val()&&q++,"-year-"===a("#"+n+"_dateyear").val()&&q++,""!==a("#"+n+"_Day").val()&&"0"!==a("#"+n+"_Day").val()||""!==a("#"+n+"_Hou").val()&&"0"!==a("#"+n+"_Hou").val()||""!==a("#"+n+"_Min").val()&&"0"!==a("#"+n+"_Min").val()||""!==a("#"+n+"_Sec").val()&&"0"!==a("#"+n+"_Sec").val()||q++,"undefined"===a("#"+n).val()&&(l=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+n).val().replace(l,"").replace(/ /g,"")&&q++);if(q==p.length)window.alert(g[1]);else{var s=d.attr("data").split(" "),t=s.pop();c.debug("Get source taxon in #"+e.parent_name(t)+"_1n0");var u=a("#"+e.parent_name(t)+"_1n0"),v=u.val();c.debug("Resulting taxonresourceid  = "+v),h.add_list_item(j,m,v)}}},add_list_item:function(b,f,g){var i="id-add-"+b,j=a("#"+i).attr("data"),k=e.next_occurrence_name(b);f++,c.debug("Next real occur is "+f);var l="elementname="+k;g&&(l+="&taxonsourceid="+g),l+="&realoccur="+f;var m=d.wwwroot+"/mod/sharedresource/ajax/getformelement.php?"+l;a.get(m,function(d){var e="#add-zone-"+b;a(d.html).insertBefore(e),i=CSS.escape(i);var g="id-add-"+k;g=CSS.escape(g),a("#"+i).attr("name","btn-"+d.name),a("#"+i).attr("id",g),a("#"+g).prop("disabled",!0),a("#"+g).attr("data-occur",f),c.debug("Shifting button "+g+" real occur as "+f),a("#add-zone-"+b).attr("id","add-zone-"+k),a("#"+g).attr("data",j),h.bind_all(),h.bind_tabs()},"json")},activate_up_chain:function(b){var d=b;for(c.debug("Processing to elementkey "+b),d=e.parent_name(d);d;)c.debug("Escalading to parentkey "+d),c.debug("Detected "+a("#id-add-"+d).attr("name")),c.debug("Detected "+a("#id-add-"+d).prop("disabled")),a("#id-add-"+CSS.escape(d)).prop("disabled",!1),d=e.parent_name(d)},reload_taxonomy:function(b){b.stopPropagation();var c=a(this),f=d.wwwroot+"/mod/sharedresource/ajax/gettaxonomymenu.php?id="+c.val();a.get(f,function(b){var d=e.parent_name(c.attr("id"));a('[data-source="'+d+'"]').each(function(){a(this).html(b),a(this).val("")})},"html")},check_empty:function(){var b=a(this);c.debug("Check "+b.attr("id"));var d=b.attr("id").substring(0,1);if(b.val()){b.parent(".mtd-form-element").removeClass("is-empty");var e=a(".mtd-form-element.is-mandatory-"+d+".is-empty");e&&0!==e.length||a("#id-menu-"+d).removeClass("is-empty");var f=a(".mtd-form-element.is-mandatory.is-empty");f&&0!==f.length||(a("#id-mtd-submit").attr("disabled",!1),a("#id-mtd-submit").removeClass("is-disabled"))}else b.parent(".mtd-form-element").addClass("is-empty"),b.hasClass("is-mandatory")&&(a("#id-mtd-submit").attr("disabled",!0),a("#id-mtd-submit").addClass("is-disabled"),a("#id-menu-"+d).addClass("is-empty"));var g=a('input[name^="btn-'+b.attr("id")+'-"]');g.each(h.check_button_status)}};return h});