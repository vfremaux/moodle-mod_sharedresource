define(["jquery","core/str","core/log","core/config","mod_sharedresource/metadata"],function(a,b,c,d,e){var f,g,h={init:function(d){f=d;var e=[{key:"fillprevious",component:"sharedresource"},{key:"fillcategory",component:"sharedresource"}];b.get_strings(e).done(function(a){g=a}),a('.mtd-form-element.is-mandatory input[type="text"]').bind("change",this.check_empty),a('.mtd-form-element.is-mandatory input[type="text"]').trigger("change"),a(".mtd-form-element.is-mandatory select").bind("change",this.check_empty),a(".mtd-form-element.is-mandatory select").trigger("change"),a(".mtd-form-element.is-mandatory textarea").bind("change",this.check_empty),a(".mtd-form-element.is-mandatory textarea").trigger("change"),a(".mtd-form-addbutton").bind("click",this.add_node),a(".mtd-tab").bind("click",this.switch_tab),a(".mtd-form-input").bind("change",this.activate_add_button),a(".mtd-tab a").bind("click",function(a){a.preventDefault()});var h="."+f+"-system-read";h+=",."+f+"-indexer-read",h+=",."+f+"-author-read",a(h).bind("change",this.enable_search_widget_checkbox),a(".taxonomy-source").bind("change",this.reload_taxonomy),a("#id-mtd-form").on("change",".taxonomy-source",null,this.reload_taxonomy),c.debug("AMD Mod sharedresource metadata edition form initialized"),a(".mtd-tab").removeClass("here"),a(".mtd-tab").removeClass("current"),a("#id-menu-1").addClass("here"),a("#id-menu-1").addClass("current"),a(".mtd-content").removeClass("active"),a(".mtd-content").removeClass("on"),a(".mtd-content").addClass("off"),a("#id-tab-1").addClass("active"),a("#id-tab-1").removeClass("off"),a("#id-tab-1").addClass("on"),c.debug("AMD Mod sharedresource metadata default switch to tab General")},switch_tab:function(b){b.stopPropagation();var c=a(this);c.attr("id")||(c=c.parent());var d=c.attr("id"),e=/id-menu-([^-]+)$/,f=c.attr("id").match(e),g="id-tab-"+f[1];a(".mtd-tab").removeClass("here"),a(".mtd-tab").removeClass("current"),a("#"+d).addClass("here"),a("#"+d).addClass("current"),a(".mtd-content").removeClass("active"),a(".mtd-content").removeClass("on"),a(".mtd-content").addClass("off"),a("#"+g).addClass("active"),a("#"+g).removeClass("off"),a("#"+g).addClass("on")},add_node:function(b){b.stopPropagation();var c=a(this),d=/btn-([^-]+)-([^-]+)/,e=c.attr("name").match(d),f=e[1],i=e[2],j="",k=c.attr("data-occur");if("category"!=i){switch(i){case"text":case"codetext":if(""===a("#"+f).val())return void window.alert(g[0]);break;case"select":if("basicvalue"===a("#"+f).val())return void window.alert(g[0]);break;case"date":if("- Year -"===a("#"+f+"_dateyear").val())return void window.alert(g[0]);break;case"duration":if(!(""!==a("#"+f+"_Day").val()&&"0"!==a("#"+f+"_Day").val()||""!==a("#"+f+"_Hou").val()&&"0"!==a("#"+f+"_Hou").val()||""!==a("#"+f+"_Min").val()&&"0"!==a("#"+f+"_Min").val()||""!==a("#"+f+"_Sec").val()&&"0"!==a("#"+f+"_Sec").val()))return void window.alert(g[0]);break;case"vcard":if(j=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+f).val().replace(j,"").replace(/ /g,""))return void window.alert(g[0])}h.add_list_item(f,k)}else{for(var l,m=c.attr("data"),n=m.split(";"),o=0,p=0;p<n.length;p++)l=n[p],""===a("#"+l).val()&&o++,"basicvalue"===a("#"+l).val()&&o++,"-year-"===a("#"+l+"_dateyear").val()&&o++,""!==a("#"+l+"_Day").val()&&"0"!==a("#"+l+"_Day").val()||""!==a("#"+l+"_Hou").val()&&"0"!==a("#"+l+"_Hou").val()||""!==a("#"+l+"_Min").val()&&"0"!==a("#"+l+"_Min").val()||""!==a("#"+l+"_Sec").val()&&"0"!==a("#"+l+"_Sec").val()||o++,"undefined"===a("#"+l).val()&&(j=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+l).val().replace(j,"").replace(/ /g,"")&&o++);o==n.length?window.alert(g[1]):h.add_list_item(f,k)}},add_list_item:function(b,c){var f=e.next_occurrence_name(b);c++;var g="elementname="+f;g+="&realoccur="+c;var i=d.wwwroot+"/mod/sharedresource/ajax/getformelement.php?"+g;a.get(i,function(c){var d="#add-zone-"+b;a(c.html).insertBefore(d);var e="id-add-"+b;e=CSS.escape(e);var g="id-add-"+f;g=CSS.escape(g),a("#"+e).attr("name","btn-"+c.name),a("#"+e).attr("id",g),a("#"+g).prop("disabled",!0),a("#add-zone-"+b).attr("id","add-zone-"+f),a("#"+b).unbind("change"),a("#"+f).bind("change",h.activate_add_button)},"json")},activate_add_button:function(b){b.stopPropagation();var d=a(this),f=d.attr("id");d.val()?a("#id-add-"+f).prop("disabled",!1):a("#id-add-"+f).prop("disabled",!0);var g=f;for(c.debug("Processing to elementkey "+f),g=e.parent_name(g);g;)c.debug("Escalading to parentkey "+g),c.debug("Detected "+a("#id-add-"+g).attr("name")),c.debug("Detected "+a("#id-add-"+g).prop("disabled")),a("#id-add-"+CSS.escape(g)).prop("disabled",!1),g=e.parent_name(g)},reload_taxonomy:function(b){b.stopPropagation();var c=a(this),f=d.wwwroot+"/mod/sharedresource/ajax/gettaxonomymenu.php?id="+c.val();a.get(f,function(b){var d=e.parent_name(c.attr("id"));a('[data-source="'+d+'"]').each(function(){a(this).html(b),a(this).val("")})},"html")},check_empty:function(){var b=a(this),c=b.attr("id").substring(0,1);if(b.val()){b.parent(".is-mandatory").removeClass("is-empty");var d=a("#mtd-form-input.is-mandatory-"+c+".is-empty");d&&0!==d.length||a("#id-menu-"+c).removeClass("is-empty");var e=a("#mtd-form-input .is-mandatory.is-empty");e&&0!==e.length||(a("#id-mtd-submit").attr("disabled",!1),a("#id-mtd-submit").removeClass("is-disabled"))}else b.parent(".is-mandatory").addClass("is-empty"),a("#id-mtd-submit").attr("disabled",!0),a("#id-mtd-submit").addClass("is-disabled"),a("#id-menu-"+c).addClass("is-empty")}};return h});