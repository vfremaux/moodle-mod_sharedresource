<<<<<<< HEAD
define ("mod_sharedresource/metadataedit",["jquery","core/str","core/log","core/config","mod_sharedresource/metadata"],function(a,b,c,d,e){var f,g,h={bind_tabs:function bind_tabs(){c.debug("AMD Mod sharedresource metadata edition binding tab events");a(".mtd-tab").bind("click",this.switch_tab);a(".mtd-tab a").bind("click",function(a){a.preventDefault()})},bind_all:function bind_all(){c.debug("AMD Mod sharedresource metadata edition binding all events");a(".mtd-form-input").off("change");a(".taxonomy-source").off("change");a(".mtd-form-addbutton").off("click");a(".mtd-form-element select").off("change");a(".mtd-form-element textarea").off("keyup");a(".mtd-form-element input[type=\"text\"]").off("keyup");a(".mtd-tab").off("click");a(".mtd-tab a").off("click");a(".mtd-form-element input[type=\"text\"]").bind("keyup",this.check_empty);a(".mtd-form-element select").bind("change",this.check_empty);a(".mtd-form-element textarea").bind("keyup",this.check_empty);a(".mtd-form-addbutton").bind("click",this.add_node);var b="."+f+"-system-read";b+=",."+f+"-indexer-read";b+=",."+f+"-author-read";a(b).off("change");a(b).bind("change",this.enable_search_widget_checkbox);a(".taxonomy-source").bind("change",this.reload_taxonomy);a("#id-mtd-form").on("change",".taxonomy-source",null,this.reload_taxonomy)},trigger_all:function trigger_all(){c.debug("AMD Mod sharedresource metadata edition triggering changes");a(".mtd-form-element input[type=\"text\"]").trigger("keyup");a(".mtd-form-element textarea").trigger("keyup")},init:function init(d){f=d;b.get_strings([{key:"fillprevious",component:"sharedresource"},{key:"fillcategory",component:"sharedresource"}]).done(function(a){g=a});c.debug("AMD Mod sharedresource BIND ALL CALL");h.bind_all();h.bind_tabs();h.trigger_all();a(".mtd-form-addbutton").each(h.check_button_status);c.debug("AMD Mod sharedresource metadata edition form initialized");a(".mtd-tab").removeClass("here");a(".mtd-tab").removeClass("current");a("#id-menu-1").addClass("here");a("#id-menu-1").addClass("current");a(".mtd-content").removeClass("active");a(".mtd-content").removeClass("on");a(".mtd-content").addClass("off");a("#id-tab-1").addClass("active");a("#id-tab-1").removeClass("off");a("#id-tab-1").addClass("on");c.debug("AMD Mod sharedresource metadata default switch to tab General")},check_button_status:function check_button_status(){var b=a(this);c.debug("Check add button "+b.attr("id"));var d=b.attr("id").replace("id-add-",""),e=b.attr("data"),f=e.split(";"),g=!1,i="",j;j=f.shift();while(j!==void 0){i=a("#"+j);c.debug("   Check button dep "+i.attr("id"));if(i.parent(".mtd-form-element").hasClass("is-empty")){g=!0;break}j=f.shift()}if(g){b.prop("disabled",!0)}else{b.prop("disabled",!1)}h.activate_up_chain(d)},switch_tab:function switch_tab(b){b.stopPropagation();var c=a(this);if(!c.attr("id")){c=c.parent()}var d=c.attr("id"),e=c.attr("id").match(/id-menu-([^-]+)$/),f="id-tab-"+e[1];a(".mtd-tab").removeClass("here");a(".mtd-tab").removeClass("current");a("#"+d).addClass("here");a("#"+d).addClass("current");a(".mtd-content").removeClass("active");a(".mtd-content").removeClass("on");a(".mtd-content").addClass("off");a("#"+f).addClass("active");a("#"+f).removeClass("off");a("#"+f).addClass("on")},add_node:function add_node(b){b.stopPropagation();var d=a(this),f=d.attr("name").match(/btn-([^-]+)-([^-]+)/),j=f[1],k=f[2],l="",m=d.attr("data-occur");c.debug("found real occur as "+m);if("category"!=k){switch(k){case"text":case"codetext":{if(""===a("#"+j).val()){window.alert(g[0]);return}break}case"select":{if("basicvalue"===a("#"+j).val()){window.alert(g[0]);return}break}case"date":{if("- Year -"===a("#"+j+"_dateyear").val()){window.alert(g[0]);return}break}case"duration":{if((""===a("#"+j+"_Day").val()||"0"===a("#"+j+"_Day").val())&&(""===a("#"+j+"_Hou").val()||"0"===a("#"+j+"_Hou").val())&&(""===a("#"+j+"_Min").val()||"0"===a("#"+j+"_Min").val())&&(""===a("#"+j+"_Sec").val()||"0"===a("#"+j+"_Sec").val())){window.alert(g[0]);return}break}case"vcard":{l=/(\r\n|\r|\n)/g;if("BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+j).val().replace(l,"").replace(/ /g,"")){window.alert(g[0]);return}break}}h.add_list_item(j,m)}else{for(var n=d.attr("data"),o=n.split(" "),p=0,q,r=0;r<o.length;r++){q=o[r];if(""===a("#"+q).val()){p++}if("basicvalue"===a("#"+q).val()){p++}if("-year-"===a("#"+q+"_dateyear").val()){p++}if((""===a("#"+q+"_Day").val()||"0"===a("#"+q+"_Day").val())&&(""===a("#"+q+"_Hou").val()||"0"===a("#"+q+"_Hou").val())&&(""===a("#"+q+"_Min").val()||"0"===a("#"+q+"_Min").val())&&(""===a("#"+q+"_Sec").val()||"0"===a("#"+q+"_Sec").val())){p++}if("undefined"===a("#"+q).val()){l=/(\r\n|\r|\n)/g;if("BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+q).val().replace(l,"").replace(/ /g,"")){p++}}}if(p==o.length){window.alert(g[1])}else{var s=d.attr("data").split(" "),t=s.pop();c.debug("Get source taxon in #"+e.parent_name(t)+"_1n0");var u=a("#"+e.parent_name(t)+"_1n0"),v=u.val();c.debug("Resulting taxonresourceid  = "+v);h.add_list_item(j,m,v)}}},add_list_item:function add_list_item(b,f,g){var i="id-add-"+b,j=a("#"+i).attr("data"),k=e.next_occurrence_name(b);f++;c.debug("Next real occur is "+f);var l="elementname="+k;if(g){l+="&taxonsourceid="+g}l+="&realoccur="+f;var m=d.wwwroot+"/mod/sharedresource/ajax/getformelement.php?"+l;a.get(m,function(d){a(d.html).insertBefore("#add-zone-"+b);i=CSS.escape(i);var e="id-add-"+k;e=CSS.escape(e);a("#"+i).attr("name","btn-"+d.name);a("#"+i).attr("id",e);a("#"+e).prop("disabled",!0);a("#"+e).attr("data-occur",f);c.debug("Shifting button "+e+" real occur as "+f);a("#add-zone-"+b).attr("id","add-zone-"+k);a("#"+e).attr("data",j);h.bind_all();h.bind_tabs()},"json")},activate_up_chain:function activate_up_chain(b){var d=b;c.debug("Processing to elementkey "+b);d=e.parent_name(d);while(d){c.debug("Escalading to parentkey "+d);c.debug("Detected "+a("#id-add-"+d).attr("name"));c.debug("Detected "+a("#id-add-"+d).prop("disabled"));a("#id-add-"+CSS.escape(d)).prop("disabled",!1);d=e.parent_name(d)}},reload_taxonomy:function reload_taxonomy(b){b.stopPropagation();var c=a(this),f=d.wwwroot+"/mod/sharedresource/ajax/gettaxonomymenu.php?id="+c.val();a.get(f,function(b){var d=e.parent_name(c.attr("id"));a("[data-source=\""+d+"\"]").each(function(){a(this).html(b);a(this).val("")})},"html")},check_empty:function check_empty(){var b=a(this);c.debug("Check "+b.attr("id"));var d=b.attr("id").substring(0,1);if(b.val()){b.parent(".mtd-form-element").removeClass("is-empty");var e=a(".mtd-form-element.is-mandatory-"+d+".is-empty");if(!e||0===e.length){a("#id-menu-"+d).removeClass("is-empty")}var f=a(".mtd-form-element.is-mandatory.is-empty");if(!f||0===f.length){a("#id-mtd-submit").attr("disabled",!1);a("#id-mtd-submit").removeClass("is-disabled")}}else{b.parent(".mtd-form-element").addClass("is-empty");if(b.hasClass("is-mandatory")){a("#id-mtd-submit").attr("disabled",!0);a("#id-mtd-submit").addClass("is-disabled");a("#id-menu-"+d).addClass("is-empty")}}var g=a("input[name^=\"btn-"+b.attr("id")+"-\"]");g.each(h.check_button_status)}};return h});
//# sourceMappingURL=metadataedit.min.js.map
=======
/**
 * AMD module for editing metadata
 * @module     mod_sharedresource/view
 * @package    blocks
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_sharedresource/metadataedit",["jquery","core/str","core/log","core/config","mod_sharedresource/metadata"],(function($,str,log,cfg,metadata){var namespace,mtdstrings,metadataedit={bind_tabs:function(){log.debug("AMD Mod sharedresource metadata edition binding tab events"),$(".mtd-tab").bind("click",this.switch_tab),$(".mtd-tab a").bind("click",(function(e){e.preventDefault()}))},bind_all:function(){log.debug("AMD Mod sharedresource metadata edition binding all events"),$(".mtd-form-input").off("change"),$(".taxonomy-source").off("change"),$(".mtd-form-addbutton").off("click"),$(".mtd-form-element select").off("change"),$(".mtd-form-element textarea").off("keyup"),$('.mtd-form-element input[type="text"]').off("keyup"),$(".mtd-tab").off("click"),$(".mtd-tab a").off("click"),$('.mtd-form-element input[type="text"]').bind("keyup",this.check_empty),$(".mtd-form-element select").bind("change",this.check_empty),$(".mtd-form-element textarea").bind("keyup",this.check_empty),$(".mtd-form-addbutton").bind("click",this.add_node);var selector="."+namespace+"-system-read";selector+=",."+namespace+"-indexer-read",$(selector+=",."+namespace+"-author-read").off("change"),$(selector).bind("change",this.enable_search_widget_checkbox),$(".taxonomy-source").bind("change",this.reload_taxonomy),$("#id-mtd-form").on("change",".taxonomy-source",null,this.reload_taxonomy)},trigger_all:function(){log.debug("AMD Mod sharedresource metadata edition triggering changes"),$('.mtd-form-element input[type="text"]').trigger("keyup"),$(".mtd-form-element textarea").trigger("keyup")},init:function(args){namespace=args;str.get_strings([{key:"fillprevious",component:"sharedresource"},{key:"fillcategory",component:"sharedresource"}]).done((function(strings){mtdstrings=strings})),log.debug("AMD Mod sharedresource BIND ALL CALL"),metadataedit.bind_all(),metadataedit.bind_tabs(),metadataedit.trigger_all(),$(".mtd-form-addbutton").each(metadataedit.check_button_status),log.debug("AMD Mod sharedresource metadata edition form initialized"),$(".mtd-tab").removeClass("here"),$(".mtd-tab .nav-link").removeClass("active"),$("#id-menu-1").addClass("here"),$("#id-menu-1 .nav-link").addClass("active"),$(".mtd-content").removeClass("active"),$(".mtd-content").removeClass("on"),$(".mtd-content").addClass("off"),$("#id-tab-1").addClass("active"),$("#id-tab-1").removeClass("off"),$("#id-tab-1").addClass("on"),log.debug("AMD Mod sharedresource metadata default switch to tab General")},check_button_status:function(){var that=$(this);log.debug("Check add button "+that.attr("id"));var dep,elementname=that.attr("id").replace("id-add-",""),depsarr=that.attr("data").split(";"),hassomeempty=!1,depelm="";for(dep=depsarr.shift();void 0!==dep;){if(depelm=$("#"+dep),log.debug("   Check button dep "+depelm.attr("id")),depelm.parent(".mtd-form-element").hasClass("is-empty")){hassomeempty=!0;break}dep=depsarr.shift()}hassomeempty?that.prop("disabled",!0):that.prop("disabled",!1),metadataedit.activate_up_chain(elementname)},switch_tab:function(e){e.stopPropagation();var that=$(this);that.attr("id")||(that=that.parent());var menuid=that.attr("id"),tabid="id-tab-"+that.attr("id").match(/id-menu-([^-]+)$/)[1];$(".mtd-tab").removeClass("here"),$(".mtd-tab .nav-link").removeClass("active"),$("#"+menuid).addClass("here"),$("#"+menuid+" .nav-link").addClass("active"),$(".mtd-content").removeClass("active"),$(".mtd-content").removeClass("on"),$(".mtd-content").addClass("off"),$("#"+tabid).addClass("active"),$("#"+tabid).removeClass("off"),$("#"+tabid).addClass("on")},add_node:function(e){e.stopPropagation();var that=$(this),matches=that.attr("name").match(/btn-([^-]+)-([^-]+)/),elmid=matches[1],fieldtype=matches[2],rgx="",realoccur=that.attr("data-occur");if(log.debug("found real occur as "+realoccur),"category"!=fieldtype){switch(fieldtype){case"text":case"codetext":if(""===$("#"+elmid).val())return void window.alert(mtdstrings[0]);break;case"select":if("basicvalue"===$("#"+elmid).val())return void window.alert(mtdstrings[0]);break;case"date":if("- Year -"===$("#"+elmid+"_dateyear").val())return void window.alert(mtdstrings[0]);break;case"duration":if(!(""!==$("#"+elmid+"_Day").val()&&"0"!==$("#"+elmid+"_Day").val()||""!==$("#"+elmid+"_Hou").val()&&"0"!==$("#"+elmid+"_Hou").val()||""!==$("#"+elmid+"_Min").val()&&"0"!==$("#"+elmid+"_Min").val()||""!==$("#"+elmid+"_Sec").val()&&"0"!==$("#"+elmid+"_Sec").val()))return void window.alert(mtdstrings[0]);break;case"vcard":if(rgx=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===$("#"+elmid).val().replace(rgx,"").replace(/ /g,""))return void window.alert(mtdstrings[0])}metadataedit.add_list_item(elmid,realoccur)}else{for(var childid,listtab=that.attr("data").split(" "),nbremptyfield=0,i=0;i<listtab.length;i++)childid=listtab[i],""===$("#"+childid).val()&&nbremptyfield++,"basicvalue"===$("#"+childid).val()&&nbremptyfield++,"-year-"===$("#"+childid+"_dateyear").val()&&nbremptyfield++,""!==$("#"+childid+"_Day").val()&&"0"!==$("#"+childid+"_Day").val()||""!==$("#"+childid+"_Hou").val()&&"0"!==$("#"+childid+"_Hou").val()||""!==$("#"+childid+"_Min").val()&&"0"!==$("#"+childid+"_Min").val()||""!==$("#"+childid+"_Sec").val()&&"0"!==$("#"+childid+"_Sec").val()||nbremptyfield++,"undefined"===$("#"+childid).val()&&(rgx=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===$("#"+childid).val().replace(rgx,"").replace(/ /g,"")&&nbremptyfield++);if(nbremptyfield==listtab.length)window.alert(mtdstrings[1]);else{var basetaxon=that.attr("data").split(" ").pop();log.debug("Get source taxon in #"+metadata.parent_name(basetaxon)+"_1n0");var taxonsourceid=$("#"+metadata.parent_name(basetaxon)+"_1n0").val();log.debug("Resulting taxonresourceid  = "+taxonsourceid),metadataedit.add_list_item(elmid,realoccur,taxonsourceid)}}},add_list_item:function(elmname,realoccur,taxonsourceid){var oldid="id-add-"+elmname,olddata=$("#"+oldid).attr("data"),newname=metadata.next_occurrence_name(elmname);realoccur++,log.debug("Next real occur is "+realoccur);var params="elementname="+newname;taxonsourceid&&(params+="&taxonsourceid="+taxonsourceid),params+="&realoccur="+realoccur;var url=cfg.wwwroot+"/mod/sharedresource/ajax/getformelement.php?"+params;$.get(url,(function(data){var zonename="#add-zone-"+elmname;$(data.html).insertBefore(zonename),oldid=CSS.escape(oldid);var newid="id-add-"+newname;newid=CSS.escape(newid),$("#"+oldid).attr("name","btn-"+data.name),$("#"+oldid).attr("id",newid),$("#"+newid).prop("disabled",!0),$("#"+newid).attr("data-occur",realoccur),log.debug("Shifting button "+newid+" real occur as "+realoccur),$("#add-zone-"+elmname).attr("id","add-zone-"+newname),$("#"+newid).attr("data",olddata),metadataedit.bind_all(),metadataedit.bind_tabs()}),"json")},activate_up_chain:function(elementname){var parentname=elementname;for(log.debug("Processing to elementkey "+elementname),parentname=metadata.parent_name(parentname);parentname;)log.debug("Escalading to parentkey "+parentname),log.debug("Detected "+$("#id-add-"+parentname).attr("name")),log.debug("Detected "+$("#id-add-"+parentname).prop("disabled")),$("#id-add-"+CSS.escape(parentname)).prop("disabled",!1),parentname=metadata.parent_name(parentname)},reload_taxonomy:function(e){e.stopPropagation();var that=$(this),url=cfg.wwwroot+"/mod/sharedresource/ajax/gettaxonomymenu.php?id="+that.val();$.get(url,(function(data){var parentid=metadata.parent_name(that.attr("id"));$('[data-source="'+parentid+'"]').each((function(){$(this).html(data),$(this).val("")}))}),"html")},check_empty:function(){var that=$(this);log.debug("Check "+that.attr("id"));var branchid=that.attr("id").substring(0,1);if(that.val()){that.parent(".mtd-form-element").removeClass("is-empty");var otheremptyonbranch=$(".mtd-form-element.is-mandatory-"+branchid+".is-empty");otheremptyonbranch&&0!==otheremptyonbranch.length||$("#id-menu-"+branchid).removeClass("is-empty");var otherempty=$(".mtd-form-element.is-mandatory.is-empty");otherempty&&0!==otherempty.length||($("#id-mtd-submit").attr("disabled",!1),$("#id-mtd-submit").removeClass("is-disabled"))}else that.parent(".mtd-form-element").addClass("is-empty"),that.hasClass("is-mandatory")&&($("#id-mtd-submit").attr("disabled",!0),$("#id-mtd-submit").addClass("is-disabled"),$("#id-menu-"+branchid).addClass("is-empty"));$('input[name^="btn-'+that.attr("id")+'-"]').each(metadataedit.check_button_status)}};return metadataedit}));

//# sourceMappingURL=metadataedit.min.js.map
>>>>>>> MOODLE_401_STABLE
