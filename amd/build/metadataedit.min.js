define(["jquery","core/str","core/log","mod_sharedresource/metadata"],function(a,b,c,d){var e,f,g={init:function(d){e=d,stringsreq=[{key:"fillprevious",component:"sharedresource"},{key:"fillcategory",component:"sharedresource"}],b.get_strings(stringsreq).done(function(a){f=a}),a(".mtd-form-addbutton").bind("click",this.add_node),a(".mtd-tab").bind("click",this.switch_tab),a(".mtd-form-input").bind("change",this.activate_add_button),a(".mtd-tab a").bind("click",function(a){a.preventDefault()}),selector="."+e+"-system-read",selector+=",."+e+"-indexer-read",selector+=",."+e+"-author-read",a(selector).bind("change",this.enable_search_widget_checkbox),a(".taxonomy-source").bind("change",this.reload_taxonomy),c.debug("AMD Mod sharedresource metadata edition form initialized")},switch_tab:function(b){b.stopPropagation(),that=a(this),that.attr("id")||(that=that.parent());var c=that.attr("id");regexp=/id-menu-([^-]+)$/,matches=that.attr("id").match(regexp);var d="id-tab-"+matches[1];a(".mtd-tab").removeClass("here"),a(".mtd-tab").removeClass("current"),a("#"+c).addClass("here"),a("#"+c).addClass("current"),a(".mtd-content").removeClass("active"),a(".mtd-content").removeClass("on"),a(".mtd-content").addClass("off"),a("#"+d).addClass("active"),a("#"+d).removeClass("off"),a("#"+d).addClass("on")},add_node:function(b){b.stopPropagation(),that=a(this),regexp=/btn-([^-]+)-([^-]+)/,matches=that.attr("name").match(regexp);var c=matches[1],d=matches[2],e=(that.hasClass("is-list"),0);if("category"!=d){switch(d){case"text":case"codetext":if(""===a("#"+c).val())return void alert(f[0]);break;case"select":if("basicvalue"===a("#"+c).val())return void alert(f[0]);break;case"date":if("- Year -"===a("#"+c+"_dateyear").val())return void alert(f[0]);break;case"duration":if(!(""!==a("#"+c+"_Day").val()&&"0"!==a("#"+c+"_Day").val()||""!==a("#"+c+"_Hou").val()&&"0"!==a("#"+c+"_Hou").val()||""!==a("#"+c+"_Min").val()&&"0"!==a("#"+c+"_Min").val()||""!==a("#"+c+"_Sec").val()&&"0"!==a("#"+c+"_Sec").val()))return void alert(f[0]);break;case"vcard":if("BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+c).val().replace(new RegExp("(\r\n|\r|\n)","g"),"").replace(/ /g,""))return void alert(f[0])}g.add_list_item(c,e)}else{var h=that.attr("data"),j=h.split(";"),k=0;for(i=0;i<j.length;i++)childid=j[i],""===a("#"+childid).val()&&k++,"basicvalue"===a("#"+childid).val()&&k++,"-year-"===a("#"+childid+"_dateyear").val()&&k++,""!==a("#"+childid+"_Day").val()&&"0"!==a("#"+childid+"_Day").val()||""!==a("#"+childid+"_Hou").val()&&"0"!==a("#"+childid+"_Hou").val()||""!==a("#"+childid+"_Min").val()&&"0"!==a("#"+childid+"_Min").val()||""!==a("#"+childid+"_Sec").val()&&"0"!==a("#"+childid+"_Sec").val()||k++,"undefined"===a("#"+childid).val()&&"BEGIN:VCARDVERSION:FN:N:END:VCARD"===a("#"+childid).val().replace(new RegExp("(\r\n|\r|\n)","g"),"").replace(/ /g,"")&&k++;k==j.length?alert(f[1]):g.add_list_item(c,e)}},add_list_item:function(b,c){newname=d.next_occurrence_name(b);var e="elementname="+newname;e+="&realoccur="+c;var f=M.cfg.wwwroot+"/mod/sharedresource/ajax/getformelement.php?"+e;a.get(f,function(c,d){zonename="#add-zone-"+b,a(c.html).insertBefore(zonename);var e="id-add-"+b;e=CSS.escape(e);var f="id-add-"+newname;f=CSS.escape(f),a("#"+e).attr("name","btn-"+c.name),a("#"+e).attr("id",f),a("#"+f).prop("disabled",!0),a("#add-zone-"+b).attr("id","add-zone-"+newname),a("#"+b).unbind("change"),a("#"+newname).bind("change",g.activate_add_button)},"json")},activate_add_button:function(b){for(b.stopPropagation(),that=a(this),elementname=that.attr("id"),that.val()?a("#id-add-"+elementname).prop("disabled",!1):a("#id-add-"+elementname).prop("disabled",!0),parentname=elementname,c.debug("Processing to elementkey "+elementname);parentname=d.parent_name(parentname);)c.debug("Escalading to parentkey "+parentname),c.debug("Detected "+a("#id-add-"+parentname).attr("name")),c.debug("Detected "+a("#id-add-"+parentname).prop("disabled")),a("#id-add-"+CSS.escape(parentname)).prop("disabled",!1)},reload_taxonomy:function(b){b.stopPropagation(),that=a(this);url=M.cfg.wwwroot+"/mod/sharedresource/ajax/gettaxonomymenu.php?id="+that.val(),a.get(url,function(b){a('[data-source="'+that.attr("id")+'"]').each(function(c){a(this).html(b),a(this).val("")})},"html")}};return g});